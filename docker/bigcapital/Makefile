# BigCapital Self-Hosted Setup (Pre-built Image)
# Makefile for managing BigCapital deployment using official Docker image

.PHONY: help up down logs status clean init backup restore

# Default target
help: ## Show this help message
	@echo "BigCapital Self-Hosted Management (Pre-built Image)"
	@echo "=================================================="
	@echo ""
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ”Œ Port mappings (to avoid conflicts with main middleware):"
	@echo "   BigCapital Web:  3000 -> 3000"
	@echo "   MariaDB:         3307 -> 3306 (external -> internal)"
	@echo "   MongoDB:         27018 -> 27017 (external -> internal)"
	@echo "   Redis:           6380 -> 6379 (external -> internal)"
	@echo ""
	@echo "âš¡ Using pre-built image: bigcapitalhq/server:latest"
	@echo "âš ï¸  Resource Requirements:"
	@echo "   - RAM: 2GB+ recommended"
	@echo "   - Storage: 10GB+ for data"
	@echo "   - CPU: 2+ cores recommended"

up: ## Start BigCapital and all dependencies
	@echo "ğŸš€ Starting BigCapital services..."
	@echo "ğŸ”§ Ensuring paperless_network exists..."
	@docker network create paperless_network 2>/dev/null || echo "âœ“ paperless_network already exists"
	@echo "ğŸ” Validating docker-compose.yml..."
	@docker-compose config -q || (echo "âŒ docker-compose.yml has errors - run 'make validate-compose' for details" && exit 1)
	@echo "âš¡ Using pre-built image - startup should be fast!"
	@docker-compose up -d
	@echo "âœ… BigCapital is starting up"
	@echo "ğŸ“± Web UI will be available at: http://simple.local:3000"
	@echo "â³ Services should be ready in 2-3 minutes..."

down: ## Stop BigCapital services
	@echo "ğŸ›‘ Stopping BigCapital services..."
	@docker-compose down
	@echo "âœ… BigCapital services stopped"

logs: ## Show BigCapital application logs
	@docker-compose logs -f bigcapital

logs-all: ## Show logs for all BigCapital services
	@docker-compose logs -f

logs-db: ## Show database logs
	@docker-compose logs -f bigcapital-mariadb

logs-mongo: ## Show MongoDB logs
	@docker-compose logs -f bigcapital-mongo

logs-redis: ## Show Redis logs
	@docker-compose logs -f bigcapital-redis

status: ## Show status of all BigCapital services
	@echo "ğŸ“Š BigCapital Services Status:"
	@docker-compose ps

init: ## Initialize BigCapital with default configuration
	@echo "ğŸ”§ Initializing BigCapital..."
	@echo "âš¡ Using pre-built image - this will be fast!"
	@$(MAKE) up
	@echo "â³ Waiting for services to be ready..."
	@sleep 45
	@echo "ğŸŒ BigCapital should now be available at: http://simple.local:3000"
	@echo ""
	@echo "ğŸ“‹ Setup Instructions:"
	@echo "   1. Open http://simple.local:3000 in your browser"
	@echo "   2. Follow the initial setup wizard"
	@echo "   3. Create your admin account"
	@echo ""
	@echo "âš ï¸  IMPORTANT: Use strong passwords and keep them secure!"

clean: ## Remove all BigCapital containers and networks (keeps data)
	@echo "ğŸ§¹ Cleaning up BigCapital containers..."
	@docker-compose down --remove-orphans
	@docker-compose rm -f
	@echo "âœ… Cleanup complete (data volumes preserved)"

clean-all: ## Remove containers, networks, and ALL DATA (destructive!)
	@echo "âš ï¸  WARNING: This will delete ALL BigCapital data!"
	@read -p "Are you sure? Type 'yes' to continue: " confirm && [ "$$confirm" = "yes" ]
	@docker-compose down -v --remove-orphans
	@docker-compose rm -f
	@echo "ğŸ’¥ All BigCapital data has been removed"

backup: ## Create backup of BigCapital data
	@echo "ğŸ’¾ Creating BigCapital backup..."
	@mkdir -p ./backups
	@echo "ğŸ“Š Backing up MariaDB..."
	@docker-compose exec -T bigcapital-mariadb mysqldump -u bigcapital -pbigcapital_secure_password bigcapital > ./backups/bigcapital-mysql-$$(date +%Y%m%d_%H%M%S).sql
	@echo "ğŸ“Š Backing up MongoDB..."
	@docker-compose exec -T bigcapital-mongo mongodump --uri="mongodb://localhost:27017/bigcapital" --archive > ./backups/bigcapital-mongo-$$(date +%Y%m%d_%H%M%S).archive
	@echo "âœ… Backup created in ./backups/"

restore-mysql: ## Restore MySQL backup (usage: make restore-mysql BACKUP_FILE=backup.sql)
	@if [ -z "$(BACKUP_FILE)" ]; then echo "âŒ Usage: make restore-mysql BACKUP_FILE=backup.sql"; exit 1; fi
	@echo "ğŸ“¥ Restoring MySQL backup: $(BACKUP_FILE)"
	@docker-compose exec -T bigcapital-mariadb mysql -u bigcapital -pbigcapital_secure_password bigcapital < $(BACKUP_FILE)
	@echo "âœ… MySQL backup restored"

restore-mongo: ## Restore MongoDB backup (usage: make restore-mongo BACKUP_FILE=backup.archive)
	@if [ -z "$(BACKUP_FILE)" ]; then echo "âŒ Usage: make restore-mongo BACKUP_FILE=backup.archive"; exit 1; fi
	@echo "ğŸ“¥ Restoring MongoDB backup: $(BACKUP_FILE)"
	@docker-compose exec -T bigcapital-mongo mongorestore --uri="mongodb://localhost:27017/bigcapital" --archive < $(BACKUP_FILE)
	@echo "âœ… MongoDB backup restored"

restart: ## Restart BigCapital services
	@echo "ğŸ”„ Restarting BigCapital services..."
	@docker-compose restart
	@echo "âœ… BigCapital services restarted"

restart-app: ## Restart only BigCapital application
	@echo "ğŸ”„ Restarting BigCapital application..."
	@docker-compose restart bigcapital
	@echo "âœ… BigCapital application restarted"

update: ## Update BigCapital to latest version
	@echo "ğŸ”„ Updating BigCapital..."
	@docker-compose pull bigcapital
	@docker-compose up -d bigcapital
	@echo "âœ… BigCapital updated to latest version"

update-all: ## Update all images to latest versions
	@echo "ğŸ”„ Updating all BigCapital images..."
	@docker-compose pull
	@docker-compose up -d
	@echo "âœ… All BigCapital services updated"

shell: ## Open shell in BigCapital container
	@docker-compose exec bigcapital /bin/bash

shell-root: ## Open root shell in BigCapital container
	@docker-compose exec -u root bigcapital /bin/bash

db-shell: ## Open MySQL shell
	@docker-compose exec bigcapital-mariadb mysql -u bigcapital -pbigcapital_secure_password bigcapital

db-shell-root: ## Open MySQL root shell
	@docker-compose exec bigcapital-mariadb mysql -u root -pbigcapital_root_password_change_me

mongo-shell: ## Open MongoDB shell
	@docker-compose exec bigcapital-mongo mongosh mongodb://localhost:27017/bigcapital

redis-shell: ## Open Redis shell
	@docker-compose exec bigcapital-redis redis-cli -a bigcapital_redis_password

config: ## Show current configuration
	@echo "ğŸ“‹ BigCapital Configuration:"
	@echo "  Web UI: http://simple.local:3000"
	@echo "  MySQL: simple.local:3307"
	@echo "  MongoDB: simple.local:27018"
	@echo "  Redis: simple.local:6380"
	@echo ""
	@echo "ğŸ”§ Container Status:"
	@$(MAKE) status

dev: ## Start with live logs for development
	@echo "ğŸ”§ Starting BigCapital in development mode..."
	@docker-compose up

# Health checks
health: ## Check health of all BigCapital services
	@echo "ğŸ” Checking BigCapital health..."
	@echo "ğŸ“Š BigCapital App:"
	@curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "200\|301\|302" && echo "âœ… BigCapital responding" || echo "âŒ BigCapital not responding"
	@echo ""
	@echo "ğŸ“Š MySQL:"
	@docker-compose exec bigcapital-mariadb mysqladmin ping -u bigcapital -pbigcapital_secure_password >/dev/null 2>&1 && echo "âœ… MySQL healthy" || echo "âŒ MySQL not responding"
	@echo ""
	@echo "ğŸ“Š MongoDB:"
	@docker-compose exec bigcapital-mongo mongosh --eval "db.runCommand('ping')" --quiet >/dev/null 2>&1 && echo "âœ… MongoDB healthy" || echo "âŒ MongoDB not responding"
	@echo ""
	@echo "ğŸ“Š Redis:"
	@docker-compose exec bigcapital-redis redis-cli -a bigcapital_redis_password ping >/dev/null 2>&1 && echo "âœ… Redis healthy" || echo "âŒ Redis not responding"

wait-ready: ## Wait for all services to be ready
	@echo "â³ Waiting for BigCapital services to be ready..."
	@echo "ğŸ“Š Checking MariaDB..."
	@until docker-compose exec bigcapital-mariadb mysqladmin ping -u bigcapital -pbigcapital_secure_password >/dev/null 2>&1; do sleep 2; done
	@echo "âœ… MariaDB is ready"
	@echo "ğŸ“Š Checking MongoDB..."
	@until docker-compose exec bigcapital-mongo mongosh --eval "db.runCommand('ping')" --quiet >/dev/null 2>&1; do sleep 2; done
	@echo "âœ… MongoDB is ready"
	@echo "ğŸ“Š Checking Redis..."
	@until docker-compose exec bigcapital-redis redis-cli -a bigcapital_redis_password ping >/dev/null 2>&1; do sleep 2; done
	@echo "âœ… Redis is ready"
	@echo "ğŸ“Š Checking BigCapital app..."
	@until curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "200\|301\|302"; do sleep 5; done
	@echo "âœ… BigCapital is ready!"
	@echo "ğŸŒ Access BigCapital at: http://simple.local:3000"

# Quick setup for first-time users
quick-start: ## Quick start - pull images and start services
	@echo "ğŸš€ BigCapital Quick Start"
	@echo "========================"
	@echo "ğŸ“¥ Pulling latest images..."
	@docker-compose pull
	@echo "ğŸ”§ Starting services..."
	@$(MAKE) up
	@echo "â³ Waiting for services to be ready..."
	@$(MAKE) wait-ready
	@echo ""
	@echo "ğŸ‰ BigCapital is ready!"
	@echo "ğŸŒ Open: http://simple.local:3000"

# Maintenance commands
prune: ## Remove unused Docker resources
	@echo "ğŸ§¹ Cleaning up unused Docker resources..."
	@docker system prune -f
	@echo "âœ… Docker cleanup complete"

reset: ## Stop, clean, and restart BigCapital
	@echo "ğŸ”„ Resetting BigCapital..."
	@$(MAKE) down
	@$(MAKE) clean
	@$(MAKE) up
	@echo "âœ… BigCapital reset complete"

# Monitoring
monitor: ## Show real-time resource usage
	@echo "ğŸ“Š BigCapital Resource Monitor"
	@echo "============================="
	@docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}" bigcapital bigcapital-mariadb bigcapital-mongo bigcapital-redis

# Integration with main middleware
integrate: ## Instructions for integrating with main docker-compose.yml
	@echo "ğŸ”— Integrating BigCapital with main middleware..."
	@echo "ğŸ“ Manual integration steps:"
	@echo ""
	@echo "1. Copy BigCapital services to your main docker-compose.yml"
	@echo "2. Ensure 'paperless_network' is available"
	@echo "3. Update middleware dependencies if needed"
	@echo "4. Run: docker-compose up -d"
	@echo ""
	@echo "ğŸ’¡ BigCapital will be available at: http://simple.local:3000"

# Troubleshooting
troubleshoot: ## Run troubleshooting checks
	@echo "ğŸ” BigCapital Troubleshooting"
	@echo "============================"
	@echo ""
	@echo "ğŸ“Š Service Status:"
	@$(MAKE) status
	@echo ""
	@echo "ğŸ” Health Check:"
	@$(MAKE) health
	@echo ""
	@echo "ğŸ“‹ Common Issues:"
	@echo "  - Port conflicts: Check if ports 3000, 3307, 27018, 6380 are available"
	@echo "  - Network issues: Ensure 'paperless_network' exists"
	@echo "  - Resource limits: Check available RAM and disk space"
	@echo ""
	@echo "ğŸ”§ Quick fixes:"
	@echo "  - Restart services: make restart"
	@echo "  - Clean restart: make reset"
	@echo "  - Check logs: make logs"

# Environment validation
validate-env: ## Validate environment and prerequisites
	@echo "ğŸ” Validating BigCapital environment..."
	@echo "ğŸ“Š Docker version:"
	@docker --version
	@echo "ğŸ“Š Docker Compose version:"
	@docker-compose --version
	@echo "ğŸ“Š Available disk space:"
	@df -h . | tail -n 1
	@echo "ğŸ“Š Available memory:"
	@free -h | grep Mem
	@echo "ğŸ“Š Port availability:"
	@netstat -tuln | grep -E ":3000|:3307|:27018|:6380" || echo "âœ… Required ports appear to be available"
	@echo "âœ… Environment validation complete"

validate-compose: ## Validate docker-compose.yml configuration
	@echo "ğŸ” Validating docker-compose.yml..."
	@docker-compose config || echo "âŒ docker-compose.yml has configuration errors"
	@echo "ğŸ” Checking volume declarations..."
	@docker-compose config --volumes || echo "âŒ Volume configuration issues found"

fix-compose: ## Fix common docker-compose.yml issues
	@echo "ğŸ”§ Checking for missing volume declarations..."
	@echo "ğŸ“‹ Your docker-compose.yml should include these volumes:"
	@echo "volumes:"
	@echo "  bigcapital_mariadb:"
	@echo "    driver: local"
	@echo "  bigcapital_mongo:"
	@echo "    driver: local"
	@echo "  bigcapital_redis:"
	@echo "    driver: local"
	@echo "  bigcapital_uploads:"
	@echo "    driver: local"
	@echo "  bigcapital_storage:"
	@echo "    driver: local"
	@echo "  bigcapital_logs:"
	@echo "    driver: local"
	@echo ""
	@echo "ğŸ’¡ Add the missing 'bigcapital_redis:' volume declaration to your docker-compose.yml"